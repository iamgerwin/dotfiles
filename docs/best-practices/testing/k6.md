# k6 Best Practices

## Official Documentation
- **k6 Official Site**: https://k6.io
- **Documentation**: https://k6.io/docs/
- **API Reference**: https://k6.io/docs/javascript-api/
- **Examples**: https://k6.io/docs/examples/
- **Best Practices**: https://k6.io/docs/misc/fine-tuning-os/
- **k6 Cloud**: https://k6.io/cloud/
- **Community Forum**: https://community.k6.io

## Installation and Setup

### Installation Options

#### Binary Installation
```bash
# macOS (Homebrew)
brew install k6

# Windows (Chocolatey)
choco install k6

# Windows (winget)
winget install k6

# Linux (Debian/Ubuntu)
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6

# Fedora/CentOS/RedHat
sudo dnf install https://dl.k6.io/rpm/repo.rpm
sudo dnf install k6

# Direct binary download (Linux/macOS)
wget https://github.com/grafana/k6/releases/download/v0.48.0/k6-v0.48.0-linux-amd64.tar.gz
tar -xzf k6-v0.48.0-linux-amd64.tar.gz
sudo mv k6-v0.48.0-linux-amd64/k6 /usr/local/bin/
```

#### Docker Installation
```bash
# Pull k6 Docker image
docker pull grafana/k6:latest

# Run k6 test with Docker
docker run --rm -i grafana/k6:latest run - <script.js

# Run with local script
docker run --rm -v $(pwd):/scripts grafana/k6:latest run /scripts/test.js

# Run with environment variables
docker run --rm \
  -e BASE_URL=https://api.example.com \
  -v $(pwd):/scripts \
  grafana/k6:latest run /scripts/test.js

# Docker Compose
version: '3.8'
services:
  k6:
    image: grafana/k6:latest
    volumes:
      - ./scripts:/scripts
      - ./results:/results
    environment:
      - K6_OUT=json=/results/output.json
    command: run /scripts/load-test.js
```

#### npm Installation (k6 Browser)
```bash
# Install k6 extensions for browser testing
npm install -g k6

# Verify installation
k6 version
```

### Version Check
```bash
# Check k6 version
k6 version

# Expected output:
# k6 v0.48.0 (2024-12-15T12:00:00+0000/v0.48.0-0-gabcdef12, go1.21.5, linux/amd64)
```

## Project Structure and Test Organization

### Recommended Directory Structure
```
project/
├── k6/
│   ├── config/
│   │   ├── default.json
│   │   ├── staging.json
│   │   └── production.json
│   ├── data/
│   │   ├── users.csv
│   │   ├── products.json
│   │   └── test-data.js
│   ├── lib/
│   │   ├── auth.js
│   │   ├── helpers.js
│   │   └── utils.js
│   ├── scenarios/
│   │   ├── smoke/
│   │   │   └── basic-smoke.js
│   │   ├── load/
│   │   │   └── steady-load.js
│   │   ├── stress/
│   │   │   └── spike-test.js
│   │   └── soak/
│   │       └── endurance-test.js
│   ├── tests/
│   │   ├── api/
│   │   │   ├── users-api.js
│   │   │   └── products-api.js
│   │   └── integration/
│   │       └── full-flow.js
│   ├── thresholds/
│   │   ├── api-thresholds.js
│   │   └── performance-sla.js
│   └── results/
│       ├── reports/
│       └── metrics/
├── package.json
└── README.md
```

### Base Test Template
```javascript
// test-template.js
import http from 'k6/http';
import { check, sleep, group } from 'k6';
import { Rate, Trend, Counter, Gauge } from 'k6/metrics';
import { htmlReport } from 'https://raw.githubusercontent.com/benc-uk/k6-reporter/main/dist/bundle.js';
import { textSummary } from 'https://jslib.k6.io/k6-summary/0.0.1/index.js';

// Custom metrics
const errorRate = new Rate('errors');
const successRate = new Rate('success');
const customTrend = new Trend('custom_waiting_time');
const requestCounter = new Counter('request_count');

// Test configuration
export const options = {
  scenarios: {
    default: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '2m', target: 10 },
        { duration: '5m', target: 10 },
        { duration: '2m', target: 0 },
      ],
      gracefulRampDown: '30s',
    },
  },
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    http_req_failed: ['rate<0.01'],
    errors: ['rate<0.05'],
    success: ['rate>0.95'],
  },
  tags: {
    test_type: 'load',
    environment: __ENV.ENVIRONMENT || 'test',
  },
};

// Setup function - runs once before test
export function setup() {
  const setupData = {
    baseUrl: __ENV.BASE_URL || 'https://api.example.com',
    apiVersion: 'v1',
    timestamp: new Date().toISOString(),
  };

  console.log('Test setup completed:', JSON.stringify(setupData));
  return setupData;
}

// Main test function
export default function (data) {
  const baseUrl = data.baseUrl;

  group('API Health Check', () => {
    const res = http.get(`${baseUrl}/health`);

    const success = check(res, {
      'status is 200': (r) => r.status === 200,
      'response time < 200ms': (r) => r.timings.duration < 200,
    });

    errorRate.add(!success);
    successRate.add(success);
    requestCounter.add(1);
  });

  sleep(1);
}

// Teardown function - runs once after test
export function teardown(data) {
  console.log('Test teardown completed');
}

// Custom summary report
export function handleSummary(data) {
  return {
    'results/summary.html': htmlReport(data),
    'results/summary.json': JSON.stringify(data),
    stdout: textSummary(data, { indent: ' ', enableColors: true }),
  };
}
```

## Core Concepts

### Virtual Users (VUs)
Virtual Users are concurrent users that execute your test script. Each VU runs the default function in a loop.

```javascript
// Simple VU configuration
export const options = {
  vus: 10,           // Number of virtual users
  duration: '30s',   // Test duration
};

// Advanced VU configuration with stages
export const options = {
  stages: [
    { duration: '30s', target: 20 },  // Ramp up to 20 VUs over 30s
    { duration: '1m', target: 20 },   // Stay at 20 VUs for 1 minute
    { duration: '20s', target: 0 },   // Ramp down to 0 VUs
  ],
};
```

### Iterations
Iterations define how many times the test function executes.

```javascript
// Fixed iterations
export const options = {
  vus: 10,
  iterations: 100,  // Total 100 iterations across all VUs
};

// Per-VU iterations
export const options = {
  scenarios: {
    per_vu_iterations: {
      executor: 'per-vu-iterations',
      vus: 10,
      iterations: 10,  // Each VU runs 10 iterations
      maxDuration: '10m',
    },
  },
};
```

### Executors
Executors control how VUs and iterations are scheduled.

```javascript
export const options = {
  scenarios: {
    // Shared iterations across VUs
    shared_iterations: {
      executor: 'shared-iterations',
      vus: 10,
      iterations: 100,
      maxDuration: '10m',
    },

    // Per-VU iterations
    per_vu_iterations: {
      executor: 'per-vu-iterations',
      vus: 10,
      iterations: 20,
      maxDuration: '10m',
    },

    // Constant VUs
    constant_vus: {
      executor: 'constant-vus',
      vus: 30,
      duration: '5m',
    },

    // Ramping VUs
    ramping_vus: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '2m', target: 50 },
        { duration: '5m', target: 50 },
        { duration: '2m', target: 0 },
      ],
      gracefulRampDown: '30s',
    },

    // Constant arrival rate (RPS)
    constant_arrival_rate: {
      executor: 'constant-arrival-rate',
      rate: 100,           // 100 iterations per second
      timeUnit: '1s',
      duration: '5m',
      preAllocatedVUs: 50,
      maxVUs: 100,
    },

    // Ramping arrival rate
    ramping_arrival_rate: {
      executor: 'ramping-arrival-rate',
      startRate: 10,
      timeUnit: '1s',
      stages: [
        { duration: '2m', target: 50 },
        { duration: '5m', target: 50 },
        { duration: '2m', target: 0 },
      ],
      preAllocatedVUs: 50,
      maxVUs: 200,
    },

    // Externally controlled
    externally_controlled: {
      executor: 'externally-controlled',
      vus: 10,
      maxVUs: 50,
      duration: '10m',
    },
  },
};
```

### Stages
Stages define how load should ramp up and down over time.

```javascript
export const options = {
  stages: [
    { duration: '1m', target: 10 },   // Warm up
    { duration: '3m', target: 50 },   // Ramp up
    { duration: '10m', target: 50 },  // Steady state
    { duration: '2m', target: 100 },  // Spike
    { duration: '1m', target: 50 },   // Recovery
    { duration: '3m', target: 0 },    // Ramp down
  ],
  gracefulRampDown: '30s',
};
```

### Thresholds
Thresholds define pass/fail criteria for your test.

```javascript
export const options = {
  thresholds: {
    // HTTP request duration thresholds
    'http_req_duration': [
      'p(95)<500',      // 95% of requests must complete below 500ms
      'p(99)<1000',     // 99% of requests must complete below 1s
      'avg<400',        // Average must be below 400ms
      'med<300',        // Median must be below 300ms
      'min<100',        // Minimum must be below 100ms
      'max<3000',       // Maximum must be below 3s
    ],

    // Request failure rate
    'http_req_failed': [
      'rate<0.01',      // Error rate must be below 1%
    ],

    // Specific endpoint thresholds
    'http_req_duration{name:GetUsers}': ['p(95)<300'],
    'http_req_duration{name:CreateUser}': ['p(95)<500'],

    // Custom metrics
    'errors': ['rate<0.05'],
    'success': ['rate>0.95'],

    // Iteration duration
    'iteration_duration': ['p(95)<10000'],

    // Checks
    'checks': ['rate>0.99'],

    // Request rate
    'http_reqs': ['rate>100'],  // Must generate more than 100 RPS
  },
};
```

## Load Testing Patterns

### Smoke Test
Quick test with minimal load to verify the system works.

```javascript
// smoke-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  vus: 1,
  duration: '1m',
  thresholds: {
    http_req_failed: ['rate<0.01'],
    http_req_duration: ['p(95)<500'],
  },
};

export default function () {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';

  const res = http.get(`${baseUrl}/api/v1/health`);
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time OK': (r) => r.timings.duration < 200,
  });

  sleep(1);
}
```

### Load Test
Test with normal expected load.

```javascript
// load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '5m', target: 100 },   // Ramp up to 100 users
    { duration: '10m', target: 100 },  // Stay at 100 users
    { duration: '5m', target: 0 },     // Ramp down to 0
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';

  const res = http.get(`${baseUrl}/api/v1/users`);
  check(res, {
    'status is 200': (r) => r.status === 200,
  });

  sleep(Math.random() * 3 + 1);  // Random sleep 1-4 seconds
}
```

### Stress Test
Push the system beyond normal load to find breaking point.

```javascript
// stress-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '2m', target: 100 },   // Normal load
    { duration: '5m', target: 200 },   // Beyond normal load
    { duration: '2m', target: 300 },   // Breaking point
    { duration: '5m', target: 400 },   // Beyond breaking point
    { duration: '5m', target: 0 },     // Recovery
  ],
  thresholds: {
    http_req_duration: ['p(95)<1000'],  // More lenient threshold
    http_req_failed: ['rate<0.05'],
  },
};

export default function () {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';

  const res = http.get(`${baseUrl}/api/v1/users?page=1&limit=20`);
  check(res, {
    'status is 200': (r) => r.status === 200,
  });

  sleep(1);
}
```

### Spike Test
Test system behavior with sudden traffic spikes.

```javascript
// spike-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 20 },    // Normal load
    { duration: '30s', target: 200 },  // Sudden spike
    { duration: '1m', target: 200 },   // Stay at spike
    { duration: '30s', target: 20 },   // Recover to normal
    { duration: '3m', target: 20 },    // Normal load
    { duration: '30s', target: 0 },    // Ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<800'],
    http_req_failed: ['rate<0.05'],
  },
};

export default function () {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';

  const res = http.get(`${baseUrl}/api/v1/products`);
  check(res, {
    'status is 200': (r) => r.status === 200,
  });

  sleep(Math.random() * 2);
}
```

### Soak Test
Extended test to find memory leaks and degradation over time.

```javascript
// soak-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '5m', target: 50 },    // Ramp up
    { duration: '3h', target: 50 },    // Stay for 3 hours
    { duration: '5m', target: 0 },     // Ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    http_req_failed: ['rate<0.01'],
    'iteration_duration': ['p(95)<5000'],
  },
};

export default function () {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';

  const res = http.get(`${baseUrl}/api/v1/users`);
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time OK': (r) => r.timings.duration < 500,
  });

  sleep(2);
}
```

## HTTP Requests and API Testing

### Basic HTTP Requests
```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const baseUrl = 'https://api.example.com';

  // GET request
  const getRes = http.get(`${baseUrl}/api/v1/users`);
  check(getRes, { 'GET status 200': (r) => r.status === 200 });

  // POST request
  const payload = JSON.stringify({
    username: 'testuser',
    email: 'test@example.com',
  });

  const params = {
    headers: {
      'Content-Type': 'application/json',
    },
  };

  const postRes = http.post(`${baseUrl}/api/v1/users`, payload, params);
  check(postRes, { 'POST status 201': (r) => r.status === 201 });

  // PUT request
  const putRes = http.put(`${baseUrl}/api/v1/users/123`, payload, params);
  check(putRes, { 'PUT status 200': (r) => r.status === 200 });

  // PATCH request
  const patchPayload = JSON.stringify({ email: 'newemail@example.com' });
  const patchRes = http.patch(`${baseUrl}/api/v1/users/123`, patchPayload, params);
  check(patchRes, { 'PATCH status 200': (r) => r.status === 200 });

  // DELETE request
  const delRes = http.del(`${baseUrl}/api/v1/users/123`);
  check(delRes, { 'DELETE status 204': (r) => r.status === 204 });
}
```

### Request Parameters and Headers
```javascript
import http from 'k6/http';

export default function () {
  const baseUrl = 'https://api.example.com';

  // Query parameters
  const params = {
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'User-Agent': 'k6-load-test',
      'Authorization': `Bearer ${__ENV.API_TOKEN}`,
      'X-Request-ID': `${__VU}-${__ITER}`,
    },
    tags: { name: 'GetUsers' },
    timeout: '60s',
  };

  const res = http.get(`${baseUrl}/api/v1/users?page=1&limit=20`, params);

  console.log(`Status: ${res.status}`);
  console.log(`Response time: ${res.timings.duration}ms`);
}
```

### Authentication
```javascript
import http from 'k6/http';
import { check } from 'k6';

export function setup() {
  const baseUrl = 'https://api.example.com';

  // Login to get token
  const loginPayload = JSON.stringify({
    email: __ENV.TEST_EMAIL || 'test@example.com',
    password: __ENV.TEST_PASSWORD || 'password123',
  });

  const loginParams = {
    headers: { 'Content-Type': 'application/json' },
  };

  const loginRes = http.post(
    `${baseUrl}/api/v1/auth/login`,
    loginPayload,
    loginParams
  );

  check(loginRes, {
    'login successful': (r) => r.status === 200,
    'has token': (r) => r.json('accessToken') !== undefined,
  });

  const authToken = loginRes.json('accessToken');

  return {
    baseUrl: baseUrl,
    token: authToken,
  };
}

export default function (data) {
  const params = {
    headers: {
      'Authorization': `Bearer ${data.token}`,
      'Content-Type': 'application/json',
    },
  };

  const res = http.get(`${data.baseUrl}/api/v1/users/me`, params);

  check(res, {
    'authenticated request successful': (r) => r.status === 200,
    'user data returned': (r) => r.json('data.id') !== undefined,
  });
}
```

### Batch Requests
```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const baseUrl = 'https://api.example.com';

  // Execute multiple requests in parallel
  const responses = http.batch([
    ['GET', `${baseUrl}/api/v1/users`],
    ['GET', `${baseUrl}/api/v1/products`],
    ['GET', `${baseUrl}/api/v1/orders`],
    ['GET', `${baseUrl}/api/v1/categories`],
  ]);

  // Check all responses
  check(responses[0], { 'users status 200': (r) => r.status === 200 });
  check(responses[1], { 'products status 200': (r) => r.status === 200 });
  check(responses[2], { 'orders status 200': (r) => r.status === 200 });
  check(responses[3], { 'categories status 200': (r) => r.status === 200 });
}
```

### Response Handling
```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const baseUrl = 'https://api.example.com';
  const res = http.get(`${baseUrl}/api/v1/users/123`);

  // Parse JSON response
  const body = res.json();
  const userId = body.data.id;
  const userEmail = body.data.email;

  // Response validation
  check(res, {
    'status is 200': (r) => r.status === 200,
    'has data': (r) => r.json('data') !== undefined,
    'user id matches': (r) => r.json('data.id') === 123,
    'has email field': (r) => r.json('data.email') !== undefined,
    'email is valid': (r) => /@/.test(r.json('data.email')),
    'response time OK': (r) => r.timings.duration < 500,
    'content type is JSON': (r) => r.headers['Content-Type'].includes('application/json'),
  });

  // Use response data in next request
  const updateRes = http.patch(
    `${baseUrl}/api/v1/users/${userId}`,
    JSON.stringify({ email: 'newemail@example.com' }),
    { headers: { 'Content-Type': 'application/json' } }
  );
}
```

## Checks and Thresholds

### Advanced Checks
```javascript
import http from 'k6/http';
import { check, group } from 'k6';
import { Rate } from 'k6/metrics';

const errorRate = new Rate('errors');

export default function () {
  const baseUrl = 'https://api.example.com';

  group('User API Tests', () => {
    const res = http.get(`${baseUrl}/api/v1/users`);

    const checkResult = check(res, {
      'status is 200': (r) => r.status === 200,
      'response has data': (r) => {
        try {
          const body = r.json();
          return body.data !== undefined && Array.isArray(body.data);
        } catch (e) {
          return false;
        }
      },
      'data is not empty': (r) => r.json('data').length > 0,
      'pagination exists': (r) => {
        const body = r.json();
        return body.pagination &&
               body.pagination.page !== undefined &&
               body.pagination.total !== undefined;
      },
      'response time < 500ms': (r) => r.timings.duration < 500,
      'response size reasonable': (r) => r.body.length < 1000000,
      'no server errors': (r) => r.status < 500,
      'content encoding is gzip': (r) => r.headers['Content-Encoding'] === 'gzip',
    });

    errorRate.add(!checkResult);
  });
}
```

### Advanced Thresholds
```javascript
export const options = {
  thresholds: {
    // HTTP metrics
    'http_req_duration': [
      'p(50)<200',
      'p(90)<500',
      'p(95)<800',
      'p(99)<1500',
      'max<5000',
    ],

    'http_req_duration{name:GetUsers}': ['p(95)<300'],
    'http_req_duration{name:CreateUser}': ['p(95)<500'],
    'http_req_duration{expected_response:true}': ['p(95)<500'],

    'http_req_failed': ['rate<0.01'],
    'http_req_failed{name:CriticalAPI}': ['rate<0.001'],

    // Request rate
    'http_reqs': ['rate>100'],
    'http_reqs{name:GetUsers}': ['rate>50'],

    // Response timing breakdown
    'http_req_connecting': ['p(95)<100'],
    'http_req_tls_handshaking': ['p(95)<200'],
    'http_req_sending': ['p(95)<10'],
    'http_req_waiting': ['p(95)<400'],
    'http_req_receiving': ['p(95)<50'],

    // Custom metrics
    'errors': ['rate<0.05'],
    'success': ['rate>0.95'],

    // Checks
    'checks': ['rate>0.99'],
    'checks{check:authentication}': ['rate>0.999'],

    // Iteration metrics
    'iteration_duration': ['p(95)<5000'],
    'iterations': ['count>1000'],

    // VU metrics
    'vus': ['value>0'],
    'vus_max': ['value<200'],

    // Data metrics
    'data_received': ['count>100000'],
    'data_sent': ['count>50000'],
  },

  // Abort test on threshold failure
  thresholds: {
    'http_req_failed': [
      { threshold: 'rate<0.01', abortOnFail: true, delayAbortEval: '10s' },
    ],
    'http_req_duration': [
      { threshold: 'p(95)<1000', abortOnFail: true, delayAbortEval: '1m' },
    ],
  },
};
```

## Custom Metrics

### Creating Custom Metrics
```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Counter, Gauge, Rate, Trend } from 'k6/metrics';

// Define custom metrics
const successfulLogins = new Counter('successful_logins');
const failedLogins = new Counter('failed_logins');
const loginDuration = new Trend('login_duration');
const activeUsers = new Gauge('active_users');
const errorRate = new Rate('custom_error_rate');
const apiResponseSize = new Trend('api_response_size');

export const options = {
  thresholds: {
    'successful_logins': ['count>100'],
    'failed_logins': ['count<10'],
    'login_duration': ['p(95)<500'],
    'active_users': ['value>0', 'value<100'],
    'custom_error_rate': ['rate<0.05'],
    'api_response_size': ['avg<50000'],
  },
};

export default function () {
  const baseUrl = 'https://api.example.com';

  // Track login duration
  const loginStart = Date.now();

  const loginRes = http.post(
    `${baseUrl}/api/v1/auth/login`,
    JSON.stringify({
      email: 'test@example.com',
      password: 'password123',
    }),
    { headers: { 'Content-Type': 'application/json' } }
  );

  const loginTime = Date.now() - loginStart;
  loginDuration.add(loginTime);

  if (loginRes.status === 200) {
    successfulLogins.add(1);
  } else {
    failedLogins.add(1);
    errorRate.add(1);
  }

  // Track active users
  activeUsers.add(__VU);

  // Track response size
  const usersRes = http.get(`${baseUrl}/api/v1/users`);
  apiResponseSize.add(usersRes.body.length);

  const success = check(usersRes, {
    'status is 200': (r) => r.status === 200,
  });

  errorRate.add(!success);

  sleep(1);
}
```

### Custom Metrics with Tags
```javascript
import http from 'k6/http';
import { Trend } from 'k6/metrics';

const customMetric = new Trend('custom_metric', true);  // Enable tags

export default function () {
  const baseUrl = 'https://api.example.com';

  const res = http.get(`${baseUrl}/api/v1/users`, {
    tags: { endpoint: 'users', method: 'GET' },
  });

  customMetric.add(res.timings.duration, {
    endpoint: 'users',
    status: res.status,
    success: res.status === 200,
  });
}

export const options = {
  thresholds: {
    'custom_metric{endpoint:users}': ['p(95)<500'],
    'custom_metric{status:200}': ['p(95)<400'],
  },
};
```

## Data Parameterization

### CSV Data Source
```javascript
import http from 'k6/http';
import { check } from 'k6';
import { SharedArray } from 'k6/data';
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';

// Load CSV data (shared across VUs)
const users = new SharedArray('users', function () {
  const csvData = papaparse.parse(open('./data/users.csv'), { header: true }).data;
  return csvData;
});

export default function () {
  const baseUrl = 'https://api.example.com';

  // Get random user from CSV
  const user = users[Math.floor(Math.random() * users.length)];

  const payload = JSON.stringify({
    username: user.username,
    email: user.email,
    firstName: user.first_name,
    lastName: user.last_name,
  });

  const res = http.post(
    `${baseUrl}/api/v1/users`,
    payload,
    { headers: { 'Content-Type': 'application/json' } }
  );

  check(res, { 'user created': (r) => r.status === 201 });
}
```

Example CSV file (`data/users.csv`):
```csv
username,email,first_name,last_name,department
john_doe,john.doe@example.com,John,Doe,Engineering
jane_smith,jane.smith@example.com,Jane,Smith,Marketing
bob_johnson,bob.johnson@example.com,Bob,Johnson,Sales
alice_williams,alice.williams@example.com,Alice,Williams,HR
charlie_brown,charlie.brown@example.com,Charlie,Brown,Finance
```

### JSON Data Source
```javascript
import http from 'k6/http';
import { SharedArray } from 'k6/data';

// Load JSON data
const products = new SharedArray('products', function () {
  return JSON.parse(open('./data/products.json'));
});

export default function () {
  const baseUrl = 'https://api.example.com';

  // Get random product
  const product = products[Math.floor(Math.random() * products.length)];

  const res = http.get(`${baseUrl}/api/v1/products/${product.id}`);
}
```

Example JSON file (`data/products.json`):
```json
[
  {
    "id": 1,
    "name": "Product A",
    "price": 29.99,
    "category": "Electronics"
  },
  {
    "id": 2,
    "name": "Product B",
    "price": 49.99,
    "category": "Clothing"
  },
  {
    "id": 3,
    "name": "Product C",
    "price": 19.99,
    "category": "Books"
  }
]
```

### Dynamic Data Generation
```javascript
import http from 'k6/http';
import { randomString, randomIntBetween } from 'https://jslib.k6.io/k6-utils/1.4.0/index.js';

export default function () {
  const baseUrl = 'https://api.example.com';

  // Generate random data
  const username = `user_${randomString(8)}`;
  const email = `${randomString(10)}@example.com`;
  const age = randomIntBetween(18, 65);

  const payload = JSON.stringify({
    username: username,
    email: email,
    age: age,
    timestamp: new Date().toISOString(),
  });

  const res = http.post(
    `${baseUrl}/api/v1/users`,
    payload,
    { headers: { 'Content-Type': 'application/json' } }
  );
}
```

### Using SharedArray for Performance
```javascript
import { SharedArray } from 'k6/data';

// Efficient: Loaded once and shared across all VUs
const data = new SharedArray('cached-data', function () {
  return JSON.parse(open('./large-dataset.json'));
});

// Inefficient: Loaded separately for each VU (DO NOT USE)
// const data = JSON.parse(open('./large-dataset.json'));

export default function () {
  const item = data[__ITER % data.length];
  // Use item in your test
}
```

## CI/CD Integration

### GitHub Actions
```yaml
# .github/workflows/k6-load-test.yml
name: k6 Load Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'load'
        type: choice
        options:
          - smoke
          - load
          - stress
          - spike
          - soak

jobs:
  k6-load-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Verify k6 installation
        run: k6 version

      - name: Run smoke test
        if: github.event_name == 'pull_request'
        env:
          BASE_URL: ${{ secrets.STAGING_API_URL }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          k6 run \
            --out json=results/smoke-results.json \
            k6/scenarios/smoke/basic-smoke.js

      - name: Run load test
        if: github.event_name == 'push' || inputs.test_type == 'load'
        env:
          BASE_URL: ${{ secrets.STAGING_API_URL }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          k6 run \
            --out json=results/load-results.json \
            --out influxdb=http://localhost:8086/k6 \
            k6/scenarios/load/steady-load.js

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: results/
          retention-days: 30

      - name: Check thresholds
        if: always()
        run: |
          if [ -f results/load-results.json ]; then
            # Parse results and check if thresholds passed
            THRESHOLD_FAILURES=$(jq '.metrics.checks.values.fails' results/load-results.json)
            if [ "$THRESHOLD_FAILURES" -gt 0 ]; then
              echo "Performance thresholds failed!"
              exit 1
            fi
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('results/smoke-results.json'));

            const comment = `## k6 Load Test Results

            **Test Type:** Smoke Test
            **Duration:** ${results.state.testRunDurationMs}ms

            ### Metrics:
            - **HTTP Requests:** ${results.metrics.http_reqs.values.count}
            - **Request Duration (p95):** ${results.metrics.http_req_duration.values['p(95)']}ms
            - **Failed Requests:** ${results.metrics.http_req_failed.values.rate * 100}%
            - **Checks Passed:** ${results.metrics.checks.values.rate * 100}%
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
```

### GitLab CI
```yaml
# .gitlab-ci.yml
stages:
  - test
  - performance

variables:
  K6_VERSION: "0.48.0"
  BASE_URL: "https://api.example.com"

k6-smoke-test:
  stage: test
  image: grafana/k6:${K6_VERSION}
  before_script:
    - k6 version
  script:
    - k6 run
        --out json=results/smoke-results.json
        --summary-export=results/summary.json
        k6/scenarios/smoke/basic-smoke.js
  artifacts:
    when: always
    paths:
      - results/
    expire_in: 30 days
    reports:
      junit: results/junit.xml
  only:
    - merge_requests

k6-load-test:
  stage: performance
  image: grafana/k6:${K6_VERSION}
  services:
    - name: influxdb:2.7
      alias: influxdb
  variables:
    INFLUXDB_HOST: "influxdb"
    INFLUXDB_PORT: "8086"
    INFLUXDB_DB: "k6"
  before_script:
    - k6 version
    - echo "Running load test against ${BASE_URL}"
  script:
    - k6 run
        --out json=results/load-results.json
        --out influxdb=http://${INFLUXDB_HOST}:${INFLUXDB_PORT}/${INFLUXDB_DB}
        -e BASE_URL=${BASE_URL}
        -e API_TOKEN=${API_TOKEN}
        k6/scenarios/load/steady-load.js
  artifacts:
    when: always
    paths:
      - results/
    expire_in: 30 days
  only:
    - main
    - develop
  when: manual

k6-stress-test:
  stage: performance
  image: grafana/k6:${K6_VERSION}
  script:
    - k6 run
        --out json=results/stress-results.json
        k6/scenarios/stress/spike-test.js
  artifacts:
    when: always
    paths:
      - results/
    expire_in: 30 days
  only:
    - schedules
  allow_failure: true
```

### Jenkins Pipeline
```groovy
// Jenkinsfile
pipeline {
    agent any

    parameters {
        choice(name: 'TEST_TYPE', choices: ['smoke', 'load', 'stress', 'spike', 'soak'], description: 'Type of performance test')
        choice(name: 'ENVIRONMENT', choices: ['staging', 'production'], description: 'Target environment')
        string(name: 'VUS', defaultValue: '50', description: 'Number of virtual users')
        string(name: 'DURATION', defaultValue: '5m', description: 'Test duration')
    }

    environment {
        K6_VERSION = '0.48.0'
        BASE_URL = credentials('api-base-url')
        API_TOKEN = credentials('api-token')
    }

    stages {
        stage('Setup') {
            steps {
                script {
                    sh '''
                        docker pull grafana/k6:${K6_VERSION}
                    '''
                }
            }
        }

        stage('Run k6 Test') {
            steps {
                script {
                    sh """
                        docker run --rm \
                            -v \$(pwd)/k6:/scripts \
                            -v \$(pwd)/results:/results \
                            -e BASE_URL=${BASE_URL} \
                            -e API_TOKEN=${API_TOKEN} \
                            -e K6_OUT=json=/results/${params.TEST_TYPE}-results.json \
                            grafana/k6:${K6_VERSION} \
                            run /scripts/scenarios/${params.TEST_TYPE}/${params.TEST_TYPE}-test.js
                    """
                }
            }
        }

        stage('Analyze Results') {
            steps {
                script {
                    def results = readJSON file: "results/${params.TEST_TYPE}-results.json"
                    def metrics = results.metrics

                    echo "Test Results Summary:"
                    echo "- Total Requests: ${metrics.http_reqs.values.count}"
                    echo "- Request Duration (p95): ${metrics.http_req_duration.values['p(95)']}ms"
                    echo "- Failed Requests: ${metrics.http_req_failed.values.rate * 100}%"
                    echo "- Checks Passed: ${metrics.checks.values.rate * 100}%"

                    // Check thresholds
                    if (metrics.http_req_failed.values.rate > 0.01) {
                        error("Error rate exceeds threshold!")
                    }
                }
            }
        }

        stage('Publish Results') {
            steps {
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'results',
                    reportFiles: 'summary.html',
                    reportName: 'k6 Performance Report'
                ])
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'results/**/*', fingerprint: true
        }

        failure {
            emailext(
                subject: "k6 Test Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: "Performance test failed. Check results at ${env.BUILD_URL}",
                to: "${env.CHANGE_AUTHOR_EMAIL}, performance-team@example.com"
            )
        }
    }
}
```

## Cloud Execution

### k6 Cloud
```javascript
// cloud-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  // Cloud execution options
  ext: {
    loadimpact: {
      projectID: 12345,
      name: 'API Load Test',
      distribution: {
        'amazon:us:ashburn': { loadZone: 'amazon:us:ashburn', percent: 50 },
        'amazon:eu:dublin': { loadZone: 'amazon:eu:dublin', percent: 30 },
        'amazon:ap:tokyo': { loadZone: 'amazon:ap:tokyo', percent: 20 },
      },
    },
  },

  stages: [
    { duration: '5m', target: 100 },
    { duration: '10m', target: 100 },
    { duration: '5m', target: 0 },
  ],

  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const res = http.get('https://api.example.com/api/v1/users');
  check(res, { 'status is 200': (r) => r.status === 200 });
  sleep(1);
}
```

```bash
# Run test in k6 Cloud
k6 cloud script.js

# Run with token
k6 cloud --token YOUR_TOKEN script.js

# Run with custom project
k6 cloud --project-id 12345 script.js
```

### Local Execution with Cloud Results
```bash
# Run locally but stream results to k6 Cloud
k6 run --out cloud script.js

# With authentication
k6 login cloud --token YOUR_TOKEN
k6 run --out cloud script.js
```

## Integration with Grafana/InfluxDB

### InfluxDB Output
```bash
# Run k6 with InfluxDB output
k6 run --out influxdb=http://localhost:8086/k6 script.js

# With authentication
k6 run --out influxdb=http://localhost:8086/k6?user=admin&password=admin script.js

# InfluxDB v2
k6 run --out influxdb=http://localhost:8086/k6?org=myorg&bucket=k6&token=mytoken script.js
```

### Docker Compose Setup
```yaml
# docker-compose.yml
version: '3.8'

services:
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=myorg
      - DOCKER_INFLUXDB_INIT_BUCKET=k6
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=mytoken
    volumes:
      - influxdb-data:/var/lib/influxdb2

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-k6-app
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - influxdb

  k6:
    image: grafana/k6:latest
    container_name: k6
    environment:
      - K6_OUT=influxdb=http://influxdb:8086/k6?org=myorg&bucket=k6&token=mytoken
    volumes:
      - ./k6:/scripts
    command: run /scripts/load-test.js
    depends_on:
      - influxdb

volumes:
  influxdb-data:
  grafana-data:
```

### Grafana Dashboard Configuration
```json
{
  "dashboard": {
    "title": "k6 Load Testing Dashboard",
    "panels": [
      {
        "title": "HTTP Request Duration",
        "targets": [
          {
            "query": "SELECT mean(\"value\") FROM \"http_req_duration\" WHERE $timeFilter GROUP BY time($__interval)"
          }
        ]
      },
      {
        "title": "Request Rate",
        "targets": [
          {
            "query": "SELECT count(\"value\") FROM \"http_reqs\" WHERE $timeFilter GROUP BY time($__interval)"
          }
        ]
      },
      {
        "title": "Error Rate",
        "targets": [
          {
            "query": "SELECT mean(\"value\") FROM \"http_req_failed\" WHERE $timeFilter GROUP BY time($__interval)"
          }
        ]
      },
      {
        "title": "Virtual Users",
        "targets": [
          {
            "query": "SELECT mean(\"value\") FROM \"vus\" WHERE $timeFilter GROUP BY time($__interval)"
          }
        ]
      }
    ]
  }
}
```

### Prometheus Output
```bash
# Run k6 with Prometheus remote write
k6 run --out experimental-prometheus-rw script.js

# With custom endpoint
k6 run --out experimental-prometheus-rw=http://localhost:9090/api/v1/write script.js
```

## Pros and Cons

### Pros

1. **Developer-Friendly**: Tests written in JavaScript with modern ES6+ syntax, making it accessible to developers familiar with web technologies.

2. **Performance and Efficiency**: Written in Go, k6 is highly performant and can generate significant load from a single machine with low resource consumption.

3. **CLI-First Design**: Excellent command-line interface with no GUI overhead, perfect for CI/CD integration and automation.

4. **Built-in Metrics**: Comprehensive built-in metrics (request duration, failure rate, throughput) with no additional configuration required.

5. **Cloud and Local Execution**: Flexibility to run tests locally during development and scale to cloud for production-level testing.

6. **Modern Testing Patterns**: Native support for modern protocols (HTTP/2, WebSocket, gRPC) and testing patterns.

7. **Strong Community and Documentation**: Active community, excellent documentation, and regular updates from Grafana Labs.

### Cons

1. **JavaScript Limitations**: While JavaScript is familiar, k6 uses its own JavaScript runtime (goja) which doesn't support all Node.js APIs, limiting library usage.

2. **Browser Testing Limitations**: Browser testing (k6 browser) is newer and less mature compared to dedicated tools like Playwright or Selenium.

3. **Distributed Testing Complexity**: Setting up distributed testing requires additional infrastructure or k6 Cloud subscription, unlike some alternatives with built-in distributed capabilities.

4. **Resource Monitoring**: Limited built-in application/server monitoring capabilities; requires integration with external tools for comprehensive observability.

5. **Learning Curve for Non-JS Users**: Teams unfamiliar with JavaScript may face a learning curve compared to GUI-based tools like JMeter.

## Common Pitfalls

1. **Not Using SharedArray for Large Datasets**: Loading large data files without SharedArray causes memory bloat as each VU gets a copy. Always use SharedArray for data that should be shared across VUs.

2. **Ignoring VU Lifecycle**: Forgetting that setup() runs once, default() runs per iteration, and teardown() runs once. Expensive operations like authentication should be in setup(), not default().

3. **Hardcoded Sleep Times**: Using fixed sleep() values creates unrealistic traffic patterns. Use randomized sleep times to simulate real user behavior.

4. **Not Setting Proper Thresholds**: Running tests without thresholds means you have no pass/fail criteria. Always define thresholds based on your SLA requirements.

5. **Excessive Logging in Default Function**: Adding console.log() statements in the default function generates massive log output during load tests. Use sparingly or conditionally.

6. **Not Using Batch Requests**: Making sequential HTTP requests when they could be batched significantly impacts test efficiency. Use http.batch() for parallel requests.

7. **Improper Ramp-Up Configuration**: Starting with maximum load immediately doesn't give the system time to stabilize and can produce misleading results. Always include proper ramp-up stages.

8. **Not Validating Responses**: Only checking HTTP status codes without validating response content can miss functional issues. Use check() to validate response data.

9. **Running Long Tests Locally**: Executing long-duration soak tests on development machines can cause resource issues. Use cloud execution or dedicated infrastructure for extended tests.

10. **Ignoring Network Limitations**: Not accounting for network bandwidth and latency when running tests from a single machine. Distributed testing may be necessary for high-load scenarios.

## Real-World Examples

### E-Commerce User Journey
```javascript
// e-commerce-journey.js
import http from 'k6/http';
import { check, group, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';
import { SharedArray } from 'k6/data';

const errorRate = new Rate('errors');
const checkoutDuration = new Trend('checkout_duration');

const products = new SharedArray('products', function () {
  return JSON.parse(open('./data/products.json'));
});

export const options = {
  scenarios: {
    user_journey: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '2m', target: 50 },
        { duration: '5m', target: 50 },
        { duration: '2m', target: 0 },
      ],
    },
  },
  thresholds: {
    http_req_duration: ['p(95)<2000'],
    http_req_failed: ['rate<0.01'],
    errors: ['rate<0.05'],
    checkout_duration: ['p(95)<5000'],
  },
};

export function setup() {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';
  return { baseUrl };
}

export default function (data) {
  const baseUrl = data.baseUrl;
  let authToken = '';

  // User Registration/Login
  group('Authentication', () => {
    const loginRes = http.post(
      `${baseUrl}/api/v1/auth/login`,
      JSON.stringify({
        email: `user${__VU}@example.com`,
        password: 'password123',
      }),
      { headers: { 'Content-Type': 'application/json' } }
    );

    const loginSuccess = check(loginRes, {
      'login successful': (r) => r.status === 200,
      'has token': (r) => r.json('accessToken') !== undefined,
    });

    errorRate.add(!loginSuccess);

    if (loginSuccess) {
      authToken = loginRes.json('accessToken');
    }
  });

  sleep(Math.random() * 2 + 1);

  // Browse Products
  group('Browse Products', () => {
    const headers = {
      'Authorization': `Bearer ${authToken}`,
      'Content-Type': 'application/json',
    };

    const productsRes = http.get(`${baseUrl}/api/v1/products?page=1&limit=20`, { headers });

    check(productsRes, {
      'products loaded': (r) => r.status === 200,
      'has products': (r) => r.json('data.length') > 0,
    });
  });

  sleep(Math.random() * 3 + 2);

  // View Product Details
  group('View Product', () => {
    const product = products[Math.floor(Math.random() * products.length)];

    const productRes = http.get(
      `${baseUrl}/api/v1/products/${product.id}`,
      { headers: { 'Authorization': `Bearer ${authToken}` } }
    );

    check(productRes, {
      'product details loaded': (r) => r.status === 200,
      'product id matches': (r) => r.json('data.id') === product.id,
    });
  });

  sleep(Math.random() * 4 + 2);

  // Add to Cart
  group('Add to Cart', () => {
    const product = products[Math.floor(Math.random() * products.length)];

    const cartRes = http.post(
      `${baseUrl}/api/v1/cart/items`,
      JSON.stringify({
        productId: product.id,
        quantity: Math.floor(Math.random() * 3) + 1,
      }),
      { headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json',
      } }
    );

    check(cartRes, {
      'added to cart': (r) => r.status === 201,
    });
  });

  sleep(Math.random() * 2 + 1);

  // Checkout
  group('Checkout', () => {
    const checkoutStart = Date.now();

    const checkoutRes = http.post(
      `${baseUrl}/api/v1/orders`,
      JSON.stringify({
        paymentMethod: 'credit_card',
        shippingAddress: {
          street: '123 Main St',
          city: 'New York',
          zipCode: '10001',
        },
      }),
      { headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json',
      } }
    );

    const checkoutTime = Date.now() - checkoutStart;
    checkoutDuration.add(checkoutTime);

    const checkoutSuccess = check(checkoutRes, {
      'order created': (r) => r.status === 201,
      'has order id': (r) => r.json('data.orderId') !== undefined,
    });

    errorRate.add(!checkoutSuccess);
  });

  sleep(Math.random() * 1 + 1);
}

export function handleSummary(data) {
  return {
    'results/e-commerce-summary.html': htmlReport(data),
    'results/e-commerce-summary.json': JSON.stringify(data),
    stdout: textSummary(data, { indent: ' ', enableColors: true }),
  };
}
```

### API Performance Testing with Multiple Endpoints
```javascript
// api-performance.js
import http from 'k6/http';
import { check, group } from 'k6';
import { Trend } from 'k6/metrics';

const getUsersDuration = new Trend('get_users_duration');
const createUserDuration = new Trend('create_user_duration');
const updateUserDuration = new Trend('update_user_duration');
const deleteUserDuration = new Trend('delete_user_duration');

export const options = {
  scenarios: {
    read_heavy: {
      executor: 'constant-vus',
      vus: 50,
      duration: '5m',
      exec: 'readOperations',
    },
    write_operations: {
      executor: 'constant-vus',
      vus: 10,
      duration: '5m',
      exec: 'writeOperations',
      startTime: '10s',
    },
  },
  thresholds: {
    'http_req_duration{endpoint:get_users}': ['p(95)<300'],
    'http_req_duration{endpoint:create_user}': ['p(95)<500'],
    'http_req_duration{endpoint:update_user}': ['p(95)<400'],
    'http_req_duration{endpoint:delete_user}': ['p(95)<300'],
  },
};

export function readOperations() {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';

  group('Read Operations', () => {
    // List users
    const listRes = http.get(`${baseUrl}/api/v1/users?page=1&limit=20`, {
      tags: { endpoint: 'get_users' },
    });

    getUsersDuration.add(listRes.timings.duration);

    check(listRes, {
      'list users success': (r) => r.status === 200,
    });

    // Get specific user
    const userId = Math.floor(Math.random() * 1000) + 1;
    const getRes = http.get(`${baseUrl}/api/v1/users/${userId}`, {
      tags: { endpoint: 'get_user' },
    });

    check(getRes, {
      'get user success': (r) => r.status === 200 || r.status === 404,
    });
  });
}

export function writeOperations() {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';

  group('Write Operations', () => {
    // Create user
    const createPayload = JSON.stringify({
      username: `user_${__VU}_${__ITER}`,
      email: `user${__VU}_${__ITER}@example.com`,
      firstName: 'Test',
      lastName: 'User',
    });

    const createRes = http.post(
      `${baseUrl}/api/v1/users`,
      createPayload,
      {
        headers: { 'Content-Type': 'application/json' },
        tags: { endpoint: 'create_user' },
      }
    );

    createUserDuration.add(createRes.timings.duration);

    const userId = createRes.json('data.id');

    check(createRes, {
      'create user success': (r) => r.status === 201,
      'has user id': (r) => userId !== undefined,
    });

    if (userId) {
      // Update user
      const updatePayload = JSON.stringify({
        firstName: 'Updated',
        lastName: 'Name',
      });

      const updateRes = http.patch(
        `${baseUrl}/api/v1/users/${userId}`,
        updatePayload,
        {
          headers: { 'Content-Type': 'application/json' },
          tags: { endpoint: 'update_user' },
        }
      );

      updateUserDuration.add(updateRes.timings.duration);

      check(updateRes, {
        'update user success': (r) => r.status === 200,
      });

      // Delete user
      const deleteRes = http.del(`${baseUrl}/api/v1/users/${userId}`, {
        tags: { endpoint: 'delete_user' },
      });

      deleteUserDuration.add(deleteRes.timings.duration);

      check(deleteRes, {
        'delete user success': (r) => r.status === 204,
      });
    }
  });
}
```

## Best Practices Summary

1. **Start Small**: Begin with smoke tests before scaling to full load tests.

2. **Use Realistic Data**: Leverage CSV/JSON data sources with SharedArray for memory efficiency.

3. **Implement Proper Ramp-Up**: Gradually increase load to allow systems to stabilize.

4. **Define Clear Thresholds**: Set thresholds based on SLAs and business requirements.

5. **Validate Responses**: Don't just check status codes; validate response content.

6. **Monitor Both Sides**: Track both client (k6) and server metrics during tests.

7. **Use Tags for Granularity**: Tag requests and metrics for detailed analysis.

8. **Modularize Tests**: Create reusable functions and separate test scenarios.

9. **Version Control Test Scripts**: Treat performance tests like production code.

10. **Integrate into CI/CD**: Automate performance testing in your deployment pipeline.

11. **Use Cloud for Scale**: Leverage k6 Cloud for distributed testing when needed.

12. **Document Test Scenarios**: Maintain clear documentation of test objectives and configurations.

## Conclusion

k6 represents a modern approach to performance testing, combining developer-friendly JavaScript syntax with the performance of Go. Its CLI-first design, comprehensive metrics, and excellent CI/CD integration make it ideal for teams practicing DevOps and continuous delivery.

The tool excels at API and microservices testing, offering native support for modern protocols and patterns. While it has limitations in browser testing and distributed execution compared to some alternatives, its strong community support and backing from Grafana Labs ensure continued development and improvement.

For teams comfortable with JavaScript and looking for a scriptable, automation-friendly performance testing solution, k6 offers an excellent balance of power, flexibility, and ease of use. Its open-source nature and optional commercial cloud offering provide flexibility in deployment and scaling strategies.

By following the best practices outlined in this guide, teams can effectively implement comprehensive performance testing strategies that catch issues early, ensure SLA compliance, and maintain system reliability under load.
